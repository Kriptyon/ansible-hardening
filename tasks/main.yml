---
# 1. Update system
- name: Update apt cache and upgrade packages
  ansible.builtin.apt:
    update_cache: yes
    upgrade: dist
  become: yes

# 2. Install unattended-upgrades
- name: Ensure unattended-upgrades installed
  ansible.builtin.apt:
    name: unattended-upgrades
    state: present
  become: yes

# 3. Configure UFW
- name: Ensure UFW is installed
  ansible.builtin.apt:
    name: ufw
    state: present
  become: yes

- name: Configure UFW default rules
  ansible.posix.ufw:
    rule: "{{ item.rule }}"
    direction: "{{ item.direction | default(omit) }}"
    port: "{{ item.port | default(omit) }}"
    proto: "{{ item.proto | default(omit) }}"
    state: "{{ item.state | default('enabled') }}"
  loop:
    - { rule: 'allow', port: "{{ ssh_port }}", proto: tcp }
    - { rule: 'deny', direction: incoming }
    - { rule: 'allow', direction: outgoing }
  become: yes

# 4. SSH hardening
- name: Disable root login in sshd_config
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin'
    line: 'PermitRootLogin no'
    state: present
  become: yes
  notify: restart sshd

- name: Disable password authentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PasswordAuthentication'
    line: 'PasswordAuthentication no'
    state: present
  become: yes
  notify: restart sshd

- name: Disable X11 forwarding
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?X11Forwarding'
    line: 'X11Forwarding no'
    state: present
  become: yes
  notify: restart sshd

- name: Set SSH log level to VERBOSE
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?LogLevel'
    line: 'LogLevel VERBOSE'
    state: present
  become: yes
  notify: restart sshd

# 5. Remove insecure services
- name: Remove legacy insecure packages
  ansible.builtin.apt:
    name: "{{ services_to_remove }}"
    state: absent
    autoremove: yes
  become: yes

# 6. Password policies
- name: Configure password aging
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^PASS_MAX_DAYS'
    line: "PASS_MAX_DAYS {{ password_max_days }}"
  become: yes

- name: Configure minimum password age
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^PASS_MIN_DAYS'
    line: "PASS_MIN_DAYS {{ password_min_days }}"
  become: yes

- name: Configure password warning age
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^PASS_WARN_AGE'
    line: "PASS_WARN_AGE {{ password_warn_age }}"
  become: yes

- name: Ensure pwquality.conf exists with complexity rules
  ansible.builtin.blockinfile:
    path: /etc/security/pwquality.conf
    block: |
      minlen = {{ password_minlen }}
      dcredit = -1
      ucredit = -1
      ocredit = -1
      lcredit = -1
  become: yes

# 7. File permissions
- name: Ensure /etc/shadow permissions
  ansible.builtin.file:
    path: /etc/shadow
    owner: root
    group: root
    mode: 0600
  become: yes

- name: Ensure /etc/passwd permissions
  ansible.builtin.file:
    path: /etc/passwd
    owner: root
    group: root
    mode: 0644
  become: yes

- name: Ensure /etc/ssh/sshd_config permissions
  ansible.builtin.file:
    path: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: 0600
  become: yes

# 8. Auditd
- name: Install auditd
  ansible.builtin.apt:
    name: 
      - auditd
      - audispd-plugins
    state: present
  become: yes

- name: Ensure auditd service is enabled and running
  ansible.builtin.service:
    name: auditd
    state: started
    enabled: yes
  become: yes

# 9. Kernel hardening
- name: Apply kernel sysctl hardening
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_set: yes
    state: present
    reload: yes
  loop:
    - { name: kernel.kptr_restrict, value: 2 }
    - { name: kernel.dmesg_restrict, value: 1 }
    - { name: net.ipv4.conf.all.rp_filter, value: 1 }
    - { name: net.ipv4.conf.default.rp_filter, value: 1 }
    - { name: net.ipv4.conf.all.log_martians, value: 1 }
    - { name: net.ipv4.conf.default.log_martians, value: 1 }
    - { name: net.ipv4.tcp_syncookies, value: 1 }
  become: yes

# 10. Optional IPv6 disable
- name: Disable IPv6 if configured
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { name: net.ipv6.conf.all.disable_ipv6, value: 1 }
    - { name: net.ipv6.conf.default.disable_ipv6, value: 1 }
    - { name: net.ipv6.conf.lo.disable_ipv6, value: 1 }
  when: disable_ipv6
  become: yes

# 11. Disable core dumps
- name: Disable core dumps globally
  ansible.builtin.lineinfile:
    path: /etc/security/limits.conf
    line: "* hard core 0"
    state: present
  become: yes

# 12. GRUB permissions
- name: Harden GRUB files permissions
  ansible.builtin.file:
    path: /etc/grub.d/
    recurse: yes
    mode: 0600
  become: yes
